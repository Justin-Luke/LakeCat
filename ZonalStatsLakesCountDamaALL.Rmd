---
title: "LakesCount"
author: "rickD"
\e: "Thursday, July 09, 2015"
output: html_document
---

## Calculate point in polygon (count) results for dam points dataset and return in same table format as our zonal statistics for gridded datasets
```{r, cache=TRUE, eval=FALSE}
library(rgdal)
library(raster)
library(plyr)
library(dplyr)
library(foreign)

rgns <- c("NE","MA","SA","SA","SA","GL","MS","MS","MS","MS","SR","MS","MS","MS","TX","RG","CO","CO","GB","PN","CA")
names(rgns) <- c("01","02","03S","03N","03W","04","05","06","07","08","09","10L","10U","11","12","13","14","15","16","17","18")
zones <- c("01","02","03W","03","04","05","06","07","08","09","10","11","12","13","14","15","16","17","18")
setwd('D:\\Projects\\lakesAnalysis\\NHDPlus_Lakes_Basins_Rasters')
wtshds <- list.files(path='.',pattern='_wtshds.tif')
wtshds <- wtshds[lapply(wtshds,function(x) length(grep("vat",x,value=FALSE))) == 0]
wtshds <- wtshds[lapply(wtshds,function(x) length(grep("xml",x,value=FALSE))) == 0]
dams <- readOGR('D:\\Projects\\lakesAnalysis\\MetricData', layer = 'dams')

for (j in zones){
zonalAll <- data.frame(cat_gridcode=NA,CatCount=NA,NIDStorCatSum=NA,NIDStorCatMin=NA,NIDStorCatMax=NA,NIDStorCatRange=NA,NIDStorCatStd=NA,NrmStorCatSum=NA,NrmStorCatMin=NA,NrmStorCatMax=NA,NrmStorCatRange=NA,NrmStorCatStd=NA)
wsAll <- data.frame(Value=NA,Count=NA,AREASQKM=NA)
wtshdzn <- wtshds[!lapply(wtshds,function(x) length(grep(j,x,value=FALSE))) == 0]
  for (k in wtshdzn){
  cat <- raster(k)
  crs(cat) <- "+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs +ellps=GRS80 +towgs84=0,0,0"
  dams2 <- spTransform(dams, CRS(projection(cat)))
  dam.gridcode2 = extract(cat,dams2)
  dams2$cat_gridcode <- dam.gridcode2  
  dams2 <- dams2[!is.na(dams2$cat_gridcode),]
  # run once using NormStor and another using NIDStor
  zonal <- ddply(dams2@data, "cat_gridcode", summarise,  CatCount= length(cat_gridcode),
                 NIDStorCatSum = sum(NIDStorM3), NIDStorCatMin = min(NIDStorM3), 
                 NIDStorCatMax = max (NIDStorM3), NIDStorCatRange = NIDStorCatMax - NIDStorCatMin, 
                 NIDStorCatStd =  sd(NIDStorM3), NrmStorCatSum = sum(NrmStorM3), 
                 NrmStorCatMin = min(NrmStorM3), NrmStorCatMax = max (NrmStorM3), 
                 NrmStorCatRange = NrmStorCatMax - NrmStorCatMin, NrmStorCatStd =  sd(NrmStorM3)  )
  
  zonalAll  <- rbind(zonal,zonalAll) 
  cat.area <- read.dbf(paste(c("D:/Projects/lakesAnalysis/NHDPlus_Lakes_Basins_Rasters/reg",substr(k,4,6),"_wtshds.tif.vat.dbf"),collapse=''))
  cat.area$AREASQKM <- (cat.area$Count * 900) * 0.000001
  wsAll <- rbind(cat.area,wsAll)
  } 
wsAll <- group_by(wsAll, Value)
wsAll <- filter(wsAll, AREASQKM == max(AREASQKM))
wsAll <- filter(wsAll, row_number(Value) == 1)
zonalAll <- group_by(zonalAll, cat_gridcode)
zonalAll <- filter(zonalAll, CatCount == max(CatCount))
zonalAll <- filter(zonalAll, row_number(cat_gridcode) == 1)
results <- merge(wsAll[,c(1,3)],zonalAll, by.x="Value", by.y="cat_gridcode",all.x=T)
names(results)[1] <- c("COMID")
names(results)[2] <- c("CatAreaSqKm")
# Catchment mean storage is storage volume divided by catnment area
results$CatMean <- results$CatCount / results$CatAreaSqKm
results$NIDStorCatMean <- results$NIDStorCatSum / results$CatAreaSqKm
results$NrmStorCatMean <- results$NrmStorCatSum / results$CatAreaSqKm
results$CatPctFull <- 100
# set all NAs to zeros
results[is.na(results)] <- 0
#results <- results[c(1:3,9:10)]
write.csv(results, paste(c("D:\\Projects\\lakesAnalysis\\Output\\dams\\zonalstats_dams",substr(k,4,5),".csv"),collapse=''), row.names=F)
cat("done with ",j)
  }
```
