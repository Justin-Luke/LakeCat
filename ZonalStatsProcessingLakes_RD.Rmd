---
title: "Zonal Stats Processing Lakes"
author: "Marc Weber"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    theme: cosmo
    highlighted: default 
---

## Clean up continuous zonal statistics results to explicitly include amount of missing data, rename fields, and include all NHDPlus catchments that were all no-data and not returned in zonal statistics as table results
```{r, cache=TRUE, eval=F}
library(foreign)
library(dplyr)
library(plyr)
library(dplyr)
landscape_layer = 'nlcd2006'

setwd(paste(c('D:/Projects/lakesAnalysis/Output/',landscape_layer),collapse=''))
files <- list.files(path='.', pattern=paste(c("zonalstats_",landscape_layer,".*\\.dbf$"), collapse=''))
#create rpu - hydroregion lookup
lookup= data.frame( 
  rpu=c("01a", "02a", "02b", "03a", "03b", "03c", "03d", "03e", "03f", "03g", "04a", "04b","04c", "04d", "05a", "05b", "05c", "05d", "06a", "07a", "07b", "07c", "08a", "08b","09a", "10a", "10b", "10c", "10d", "10e", "10f", "10g", "10h", "10i", "11a", "11b", "11c", "11d", "12a", "12b", "12c", "12d", "13a", "13b", "13c", "13d", "14a", "14b","15a", "15b", "16a", "16b", "17a", "17b", "17c", "17d", "18a", "18b", "18c"),
  hr=c("01", "02", "02", "03N", "03N", "03S", "03S", "03W", "03W", "08", "04", "04","04", "04", "05", "05", "05", "05", "06", "07", "07", "07", "08", "08","09", "10L", "10L", "10L", "10L", "10U", "10U", "10U", "10U", "10U", "11", "11", "11", "11", "12", "12", "12", "12", "13", "13", "13", "13", "14", "14","15", "15", "16", "16", "17", "17", "17", "17", "18", "18", "18"),stringsAsFactors = FALSE)

hydro_reg <- c("01","02","03S","03N","03W","04","05","06","07","08","09","10L","10U","11","12","13","14","15","16","17","18")

for (k in 1:length(hydro_reg)){
  if (!file.exists(paste(c("D:/Projects/lakesAnalysis/Output/Off-NetworkCatResults/",landscape_layer,"_",hydro_reg[k],".csv"),collapse='')))
  setwd(paste(c('D:/Projects/lakesAnalysis/Output/',landscape_layer),collapse=''))
  sublist = lookup[lookup$hr==hydro_reg[k],]
  subvector = paste(as.vector(sublist$rpu),collapse="|")
  files.subset = subset(files, grepl(subvector, files))
  zonal <- ldply(files.subset, read.dbf)
  # drop the extraneous border values (double counts)
  zonal <- group_by(zonal, Value)
  # get rid of erroneous COMIDs with smaller areas
  zonal <- filter(zonal, AREA == max(AREA))
  # get rid of duplicate COMIDs with exact same info
  zonal <- filter(zonal, row_number(Value) == 1)
  
  #read raster attribute table to make sure all raster categories are listed for each hydro region
  setwd('D:/Projects/lakesAnalysis/NHDPlus_Lakes_Basins_Rasters')
  rpu_rats <- list.files(path='.', pattern="_wtshd.*\\.dbf$")
  sublist = lookup[lookup$hr==hydro_reg[k],]
  subvector = paste(as.vector(sublist$rpu),collapse="|")
  files.subset = subset(rpu_rats, grepl(subvector, files))
  rat <- ldply(files.subset, read.dbf)  
  rat$FullArea<- rat$Count * 900
  rat <- group_by(rat, Value)
  # get rid of erroneous COMIDs with smaller areas
  rat <- filter(rat, FullArea == max(FullArea))
  # get rid of duplicate COMIDs with exact same info
  rat <- filter(rat, row_number(Value) == 1)
  results <- merge(rat[,c(1,3)],zonal, by="Value", all.x=T)
  results$CatPctFull <- (results$AREA / results$FullArea) * 100
  head(results)
  results$CatAreaSqKM <- results$FullArea*  1.0e-6
  results.names= c('Value','CatAreaSqKM','MEAN','CatPctFull','COUNT','MIN','MAX','RANGE','STD','SUM')
  results <- results[, c(results.names)]
  names(results) <- c('COMID','CatAreaSqKM','CatMean','CatPctFull','CatCount','CatMin','CatMax','CatRange','CatStd','CatSum')
  results[is.na(results)] <- 0    
  write.csv(results, paste(c("D:/Projects/lakesAnalysis/Output/Off-NetworkCatResults/",landscape_layer,"_",hydro_reg[k],".csv"),collapse=''), row.names=F)
}

#########################################################################################
## Clean up tabulation (categorical raster) results to explicitly include amount of missing data,rename fields, and include all NHDPlus catchments that were all no-data and not returned in zonal statistics as table results
```{r, cache=TRUE, eval=F}
library(foreign)
library(dplyr)
library(plyr)
library(dplyr)
landscape_layer = 'nlcd'

setwd('c:/temp')
files <- list.files(path='.', pattern=paste(c("zonalstats_",landscape_layer,".*\\.dbf$"), collapse=''))
#create rpu - hydroregion lookup
lookup= data.frame( 
  rpu=c("01a", "02a", "02b", "03a", "03b", "03c", "03d", "03e", "03f", "03g", "04a", "04b","04c", "04d", "05a", "05b", "05c", "05d", "06a", "07a", "07b", "07c", "08a", "08b","09a", "10a", "10b", "10c", "10d", "10e", "10f", "10g", "10h", "10i", "11a", "11b", "11c", "11d", "12a", "12b", "12c", "12d", "13a", "13b", "13c", "13d", "14a", "14b","15a", "15b", "16a", "16b", "17a", "17b", "17c", "17d", "18a", "18b", "18c"),
  hr=c("01", "02", "02", "03N", "03N", "03S", "03S", "03W", "03W", "08", "04", "04","04", "04", "05", "05", "05", "05", "06", "07", "07", "07", "08", "08","09", "10L", "10L", "10L", "10L", "10U", "10U", "10U", "10U", "10U", "11", "11", "11", "11", "12", "12", "12", "12", "13", "13", "13", "13", "14", "14","15", "15", "16", "16", "17", "17", "17", "17", "18", "18", "18"),stringsAsFactors = FALSE)

hydro_reg <- c("01","02","03S","03N","03W","04","05","06","07","08","09","10L","10U","11","12","13","14","15","16","17","18")
#read raster attribute table to make sure all raster categories are listed for each hydro region
rat <- read.dbf('L:/Priv/CORFiles/Geospatial_Library/Data/Project/SSWR1.1B/LandscapeRasters/QAComplete/nlcd2006.tif.vat.dbf')
names(rat) <- toupper(names(rat))
r <- sapply(rat$VALUE, function(x) paste(c('VALUE_',x),collapse='')) 
for (k in 1:21){
  tab <- read.dbf(paste(c("K:/Watershed Integrity Spatial Prediction/results/zonalstats_nlcd2006",hydro.rgns[k],".dbf"),collapse=''))
  head(tab)
  missing <- r[is.na(match(r, names(tab)))]
  tab[,paste(missing)] <- c(0)
  tab <- tab[c("VALUE", r)]
  lookup <- read.dbf(paste(c("E:/NHDPlusV21/NHDPlus",rgns[k],"/NHDPlus",hydro.rgns[k],"/NHDPlusCatchment/Catchment.dbf"),collapse=''))
  lookup <- lookup[lookup$GRIDCODE!=0,]
  head(lookup)
  #create new total field
  tab$AreaSqM <- rowSums(tab[,2:ncol(tab)])
  results <- merge(lookup[,c(1:2,4)],tab, by.x="GRIDCODE", by.y="VALUE",all.x=T)
  head(results)
  results$CatPctFull <- ((results$AreaSqM *  1.0e-6) / results$AreaSqKM) * 100
  results <- results[c(2:c(ncol(results)-2),c(ncol(results)))]
  names(results) <- c('COMID','CatAreaSqKM',names(results)[3:c(ncol(results))])
  results$CatPctFull[is.na(results$CatPctFull)] <- 0
  if (!file.exists(paste(c("L:/Priv/CORFiles/Geospatial_Library/Data/Project/SSWR1.1B/CatResults/NLCD2006_Ws",hydro.rgns[k],".csv"),collapse=''))){
    write.csv(results, paste(c("L:/Priv/CORFiles/Geospatial_Library/Data/Project/SSWR1.1B/CatResults/NLCD2006_Ws",hydro.rgns[k],".csv"),collapse=''), row.names=F)
    }
  }
```
